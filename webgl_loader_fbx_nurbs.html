<!DOCTYPE html>
<html lang="en">
    <head>
        <title>three.js webgl - FBX loader - Nurbs</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
            body {
                font-family: Monospace;
                background-color: #000;
                color: #fff;
                margin: 0px;
                overflow: hidden;
            }
            #info {
                color: #fff;
                position: absolute;
                top: 10px;
                width: 100%;
                text-align: center;
                z-index: 100;
                display:block;
            }
            #info a {
                color: #f00;
                font-weight: bold;
            }
        </style>
    </head>

    <body>
        <div id="info">
            OFG Maya WebGL Test<br/>
            <a onclick="toggleWireframe();">Wireframe On/Off</a>
        </div>

        <script src="js/build/three.js"></script>

        <script src="js/libs/inflate.min.js"></script>
        <script src="js/controls/OrbitControls.js"></script>

        <script src="js/curves/NURBSCurve.js"></script>
        <script src="js/curves/NURBSUtils.js"></script>
        <script src="js/loaders/FBXLoader.js"></script>

        <script src="js/Detector.js"></script>
        <script src="js/libs/stats.min.js"></script>

        <script>

            if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

            var container, stats, controls;
            var camera, scene, renderer, light;
            var loadedFbx;
            var wireframeToggle;

            init();
            animate();

            function init() {

                container = document.createElement( 'div' );
                document.body.appendChild( container );

                camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
                camera.position.set( 2, 18, 28 );

                controls = new THREE.OrbitControls( camera );
                controls.target.set( 0, 12, 0 );
                controls.update();

                scene = new THREE.Scene();

                light = new THREE.HemisphereLight( 0xffffff, 0x444444 );
                light.position.set( 0, 1, 0 );
                scene.add( light );

                light = new THREE.DirectionalLight( 0xffffff );
                light.position.set( 0, 1, 0 );
                scene.add( light );

                // grid
                var gridHelper = new THREE.GridHelper( 28, 28, 0x303030, 0x303030 );
                scene.add( gridHelper );

                // stats
                stats = new Stats();
                container.appendChild( stats.dom );

                // model
                var loader = new THREE.FBXLoader();
                loader.load( 'models/fbx/lengi_full.fbx', function( object ) {

                    object.traverse( function ( child ) {

                        if ( child.isMesh ) {

                            child.castShadow = true;
                            var tempGeo = new THREE.Geometry().fromBufferGeometry( child.geometry );
                            tempGeo.mergeVertices();
                            tempGeo.computeFaceNormals();
                            tempGeo.computeVertexNormals();
                            child.geometry = new THREE.BufferGeometry().fromGeometry( tempGeo );
                     
                        }

                    } );
                    loadedFbx = object;
                    scene.add( object );

                } );

                renderer = new THREE.WebGLRenderer();
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth, window.innerHeight );
                container.appendChild( renderer.domElement );

                window.addEventListener( 'resize', onWindowResize, false );

            }

            function toggleWireframe() {
                // model
                if (loadedFbx) {
                    if (!wireframeToggle) {
                        loadedFbx.traverse( function ( child ) {
                            if (child.isMesh) {

                                var geo = new THREE.WireframeGeometry( child.geometry );
                                var mat = new THREE.LineBasicMaterial( { color: 0xffffff, linewidth: 1 } );
                                var wireframe = new THREE.LineSegments( geo, mat );
                                child.add ( wireframe );
                                // child.material.wireframe = true
                                // console.log(child.children)
                                // console.log(child.children.array)

                            }
                        });
                        console.log("Wireframe On")
                    } else {
                        loadedFbx.traverse( function ( child ) {
                            if ( child.type == "LineSegments" ) {
                                
                                child.parent.remove( child );

                            }
                        });
                        console.log("Wireframe Off")
                    }
                    wireframeToggle = !wireframeToggle;
                    // scene.add(loadedFbx)
                } else {
                    console.error("No Fbx loaded")
                }
            }

            function onWindowResize() {

                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                renderer.setSize( window.innerWidth, window.innerHeight );

            }

            //

            function animate() {

                requestAnimationFrame( animate );

                renderer.render( scene, camera );

                stats.update();

            }

        </script>

    </body>
</html>
